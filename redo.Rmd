---
title: "redo analysis"
author: "Andrew MacDonald"
date: "April 8, 2016"
output: pdf_document
---

```{r echo=FALSE, message=FALSE}
remake::dump_environment()
```


Actually, what needs to happen here is a difference kind of _split_ in the list structure: specifcally, I want a list as long as the number of blocks (2 in this case, 5 in real life). I want each element to contain a `$factors` and a `$taxa` element.

```{r}

library(purrr)

inverts_tts_fin %>% 
  lapply(split, f = .[["factors"]][["Block"]]) %>% 
  transpose()


```

That looks like the correct operation! This `transpose()` performs exactly the operation we want.

```{r}

f <- . %>% 
  lapply(split, f = .[["factors"]][["Block"]]) %>% 
  transpose()

invert_zoops <-  
  list(inverts = inverts_tts_fin %>% f,
       zoops   = zoops_tts_fin %>% f,
       bact    = bact_tts_fin %>% f)

```

So far so good. Now let's build the PERMANOVA response:

```{r}
AdonisData <- function(Data, ...){  
  adonis(Data[["taxa"]] ~ species , data = Data[["factors"]], ...)
}

adonis_list <- invert_zoops %>% 
  at_depth(2, AdonisData)

block_level_rsqs <- adonis_list %>% 
  map(. %>% map_dbl(~.x[["aov.tab"]][["R2"]][[1]])) %>% 
  map_df(~data_frame(Block = names(.x), rsq = .x), .id = "grp")

kable(block_level_rsqs)
```

### plot the results

```{r}
block_lvl_rs_ordered <- block_level_rsqs %>%
  mutate(grp = ordered(grp, levels = c("bact", "zoops", "inverts")))

block_lvl_rs_ordered %>% 
  ggplot(aes(x = grp, y = rsq, group = Block)) +
  geom_point() + 
  geom_line()
```

Zooplankton appear to have *more*, not less, structure than macroinvertebrates.

```{r}
grp_anova <- block_lvl_rs_ordered %>% 
  lmerTest::lmer(rsq ~ grp + (1|Block), data = .) 

anova(grp_anova)
summary(grp_anova)
```

And the linear contrast is no longer significant, nor is it even positive! perhaps this was the wrong approach after all.