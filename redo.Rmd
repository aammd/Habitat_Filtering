---
title: "redo analysis"
author: "Andrew MacDonald"
date: "April 8, 2016"
output: pdf_document
---

```{r echo=FALSE, message=FALSE}
remake::dump_environment()
```


Actually, what needs to happen here is a difference kind of _split_ in the list structure: specifcally, I want a list as long as the number of blocks (2 in this case, 5 in real life). I want each element to contain a `$factors` and a `$taxa` element.

```{r}

inverts_tts_fin %>% 
  lapply(split, f = .[["factors"]][["Block"]]) %>% 
  transpose() %>% 
  at_depth(2, ~ head(.x)[1:3])

```

That looks like the correct operation! This `transpose()` performs exactly the operation we want.

```{r}

f <- . %>% 
  lapply(split, f = .[["factors"]][["Block"]]) %>% 
  transpose()

invert_zoops <-  
  list(inverts = inverts_tts_fin %>% f,
       zoops   = zoops_tts_fin %>% f,
       bact    = bact_tts_fin %>% f)


presabs <- function(df) {
  for (i in names(df)) {
    df[[i]] <- as.numeric(df[[i]] > 0)
  }
  df
}

invert_zoops_pa <- invert_zoops %>% 
  ## remove all zero species within each block:
  at_depth(2, . %>% map_at("taxa", ~.x[,(colSums(.x > 0) > 0)])) %>% 
  ## converte inverts and zoops to presence absence
  map_at(c("inverts", "zoops"), . %>% 
           map(. %>% 
                 map_at("taxa", presabs)))

```

So far so good. Now let's build the PERMANOVA response:

```{r message=FALSE}
AdonisData <- function(Data, ...){  
  adonis(Data[["taxa"]] ~ species , data = Data[["factors"]], ...)
}

rdaData <- function(Data, ...){  
  rda(Data[["taxa"]] ~ species , data = Data[["factors"]], ...)
}

adonis_list <- invert_zoops_pa %>% 
  at_depth(2, AdonisData, method = "euclid")

rda_list <- invert_zoops_pa %>% 
  at_depth(2, rdaData)


block_level_rsqs <- adonis_list %>% 
  map(. %>% map_dbl(~.x[["aov.tab"]][["R2"]][[1]])) %>% 
  map_df(~data_frame(Block = names(.x), rsq = .x), .id = "grp")

kable(block_level_rsqs)

# ## and f-vals
# block_level_fs <- adonis_list %>% 
#   map(. %>% map_dbl(~.x[["aov.tab"]][["F.Model"]][[1]])) %>% 
#   map_df(~data_frame(Block = names(.x), fval = .x), .id = "grp")
```



### plot the results

```{r}
block_lvl_rs_ordered <- block_level_rsqs %>%
  mutate(grp = ordered(grp, levels = c("bact", "zoops", "inverts")))

block_lvl_rs_ordered %>% 
  ggplot(aes(x = grp, y = rsq, group = Block)) +
  geom_point() + 
  geom_line()
```

Zooplankton appear to have *more*, not less, structure than macroinvertebrates.

```{r}
grp_anova <- block_lvl_rs_ordered %>% 
  lmerTest::lmer(rsq ~ grp + (1|Block), data = .) 

anova(grp_anova)
summary(grp_anova)
```

And the linear contrast is no longer significant, nor is it even positive! perhaps this was the wrong approach after all.

## number of species in common

first let's see what species are present everywhere

```{r}
ubiquity <- invert_zoops %>% 
  at_depth(2, . %>% map_at("taxa", ~.x[,(colSums(.x > 0) > 0)])) %>% 
  at_depth(2, . %>% map_at("taxa", ~ data_frame(ubiq = sum(colSums(.x > 0) == 6),
                                                nspp = ncol(.x)))) %>% 
  map_df(. %>% map_df("taxa", .id = "Block"), .id = "taxa")
```

OK let's try to plot that

```{r}
ubiquity %>% 
  ggplot(aes(x = nspp, y = ubiq, colour = taxa)) +
  geom_point() + 
  stat_smooth(method = "lm") +
  facet_wrap(~taxa, scales = "free")
```


## correlation analysis

could we analyze figure 3 directly, with a rank correlation test? 

```{r eval = FALSE}

sizes <- data_frame(taxa = c("bact", "zoops", "inverts"),
                    size = 1:3)



observed <- list(data_frame(name = as.character(quote(inverts_adonis_fin)), 
                number = species_r2(inverts_adonis_fin)),
     data_frame(name = as.character(quote(zoops_adonis_fin)), 
                number = species_r2(zoops_adonis_fin)),
     data_frame(name = as.character(quote(bact_adonis_fin)), 
                number = species_r2(bact_adonis_fin))) %>% 
  bind_rows() %>% 
  separate(name, into = c("taxa", "method", "time")) %>% 
  filter(time == "fin") %>% 
  left_join(sizes)  %>% 
  lm(number ~ size, data = .) %>% 
  broom::tidy()

### randomization tests

null_sims_spear <- replicate(n = 99, {
  ss <- 1:30 %>% 
    split(f = gl(5, 6)) %>% 
    lapply(sample) %>% 
    unlist
  
  inverts_tts_fin$factors$species <- inverts_tts_fin$factors$species[ss]
  zoops_tts_fin$factors$species <- zoops_tts_fin$factors$species[ss]
  bact_tts_fin$factors$species <- bact_tts_fin$factors$species[ss] 
  
  inverts_adonis_fin <- AdonisData(inverts_tts_fin, method = I("euclid"))
  
  zoops_adonis_fin <- AdonisData(zoops_tts_fin, method = I("euclid"))
  
  bact_adonis_fin <- AdonisData(bact_tts_fin, method = I("euclid"))
  
  
  list(data_frame(name = as.character(quote(inverts_adonis_fin)), 
                  number = species_r2(inverts_adonis_fin)),
       data_frame(name = as.character(quote(zoops_adonis_fin)), 
                  number = species_r2(zoops_adonis_fin)),
       data_frame(name = as.character(quote(bact_adonis_fin)), 
                  number = species_r2(bact_adonis_fin))) %>% 
    bind_rows() %>% 
    separate(name, into = c("taxa", "method", "time")) %>% 
    filter(time == "fin") %>% 
    left_join(sizes) %>% 
    lm(number ~ size, data = .) %>% 
    broom::tidy()
  
}, simplify = FALSE)

obs_slope <- observed %>% filter(term == "size") %>% .[["estimate"]]

null_sims_spear %>% 
  bind_rows(.id = "sim") %>% 
  filter(term == "size") %>% 
  .[["estimate"]] %>% 
  {c(., obs_slope) >= obs_slope} %>% 
  {sum(.)/length(.)} 


null_sims_spear %>% 
  bind_rows(.id = "sim") %>% 
  filter(term == "size") %>% 
  .[["estimate"]] %>% 
  hist(xlim = c(-0.05, 0.15), col = "lightgrey", main = "null distribution of slopes") %>% 
  abline(v = obs_slope, col = "darkgreen",  lwd = 2)
```

## reduce the number of species

let us reduce the number of species, that will be good. 

